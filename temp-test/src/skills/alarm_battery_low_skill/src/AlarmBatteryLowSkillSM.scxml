<?xml version="1.0" encoding="UTF-8"?>
<scxml xmlns="http://www.w3.org/2005/07/scxml" initial="idle" version="1.0" name="AlarmBatteryLowSkillCondition" datamodel="ecmascript">
    <!-- Variable definitions used during execution -->
    <datamodel>
        <!-- Holds the battery low flag: 1 = low, 0 = normal -->
        <data id="battery_low" expr="0"/>
        <!-- Constant representing SUCCESS status -->
        <data id="SKILL_SUCCESS" expr="0"/>
        <!-- Constant representing FAILURE status -->
        <data id="SKILL_FAILURE" expr="1"/>
    </datamodel>
    <!-- ROS2 service server that handles tick requests -->
    <!-- ROS2 topic subscriber to listen for battery low state -->
    <!-- Idle state: waits for tick and battery topic updates -->
    <state id="idle">
        <!-- When a tick is received, transition to checkLow state -->
        <transition target="checkLow" event="CMD_TICK"/>
        <!-- When a battery status update arrives, update the variable -->
        <transition target="idle" event="BatteryDriverCmp.readStatus.Sub">
            <assign location="battery_low" expr="_event.power_supply_status.battery_low"/>
        </transition>
    </state>
    <!-- Check battery state and respond accordingly -->
    <state id="checkLow">
        <onentry>
            <!-- If battery is low, return FAILURE -->
            <if cond="battery_low == 1">
                <send event="TICK_RESPONSE">
                    <param name="status" expr="SKILL_FAILURE"/>
                    <param name="is_ok" expr="false"/>
                </send>
                <else/>
                <!-- If battery is OK, return SUCCESS -->
                <send event="TICK_RESPONSE">
                    <param name="status" expr="SKILL_SUCCESS"/>
                    <param name="is_ok" expr="true"/>
                </send>
            </if>
        </onentry>
        <!-- Allow re-handling of tick while in this state -->
        <transition target="checkLow" event="CMD_TICK"/>
        <!-- After processing, return to idle state -->
        <transition target="idle"/>
    </state>
</scxml>
